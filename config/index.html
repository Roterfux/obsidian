<!DOCTYPE html>
<html>
  <head>
  <title>Obsidian Configuration</title>
  <link rel='stylesheet' type='text/css' href='css/slate.min.css'>
  <script src='js/slate.js'></script>
  <script src='js/gcolor.js'></script>
  <style>
  .title {
    padding-top: 20px;
    text-align: center;
  }
  </style>
  </head>

  <body>
    <h1 class='title'>Obsidian Configuration</h1>

    <div class='item-container'>
      <div class='item-container-header'>Appearance</div>

      <div class="item-container-content">
        <label class="item">
          Show Hour Ticks
          <select id='CONFIG_HOUR_TICKS' dir='rtl' class="item-select">
            <option class="item-select-option" value="1">All</option>
            <option class="item-select-option" value="2">Only 3, 6, 9, 12</option>
            <option class="item-select-option" value="3">None</option>
          </select>
        </label>
      </div>

      <div class="item-container-content">
        <label class="item">
          Show Minute Ticks
          <select id='CONFIG_MINUTE_TICKS' dir='rtl' class="item-select">
            <option class="item-select-option" value="1">All</option>
            <option class="item-select-option" value="2">Only relevant ticks</option>
            <option class="item-select-option" value="3">None</option>
          </select>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Outer Background Color
          <input id='CONFIG_COLOR_OUTER_BACKGROUND' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Inner Background Color
          <input id='CONFIG_COLOR_INNER_BACKGROUND' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Minute Hand Color
          <input id='CONFIG_COLOR_MINUTE_HAND' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Minute Hand Inner Color
          <input id='CONFIG_COLOR_INNER_MINUTE_HAND' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Hour Hand Color
          <input id='CONFIG_COLOR_HOUR_HAND' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Hour Hand Inner Color
          <input id='CONFIG_COLOR_INNER_HOUR_HAND' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Circle Color
          <input id='CONFIG_COLOR_CIRCLE' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Tick Color
          <input id='CONFIG_COLOR_TICKS' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Day of the Week Color
          <input id='CONFIG_COLOR_DAY_OF_WEEK' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Date Color
          <input id='CONFIG_COLOR_DATE' type='text' class='item-color item-color-normal'>
        </label>
      </div>

    </div>

    <div class='item-container'>
      <div class='item-container-header'>Battery</div>

      <div class="item-container-content">
        <label class="item">
          Battery Icon
          <select id='CONFIG_BATTERY_LOGO' dir='rtl' class="item-select">
            <option class="item-select-option" value="1">Always</option>
            <option class="item-select-option" value="2">When low (30% or below)</option>
            <option class="item-select-option" value="3">Never</option>
          </select>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Battery Icon Color
          <input id='CONFIG_COLOR_BATTERY_LOGO' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
           Low Battery (30%) Color (Icon)
          <input id='CONFIG_COLOR_BATTERY_30' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Low Battery (20%) Color (Icon)
          <input id='CONFIG_COLOR_BATTERY_20' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Low Battery (10%) Color (Icon)
          <input id='CONFIG_COLOR_BATTERY_10' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
           Low Battery (30%) Color (Background)
          <input id='CONFIG_COLOR_BATTERY_BG_30' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Low Battery (20%) Color (Background)
          <input id='CONFIG_COLOR_BATTERY_BG_20' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Low Battery (10%) Color (Background)
          <input id='CONFIG_COLOR_BATTERY_BG_10' type='text' class='item-color item-color-normal'>
        </label>
      </div>

    </div>

    <div class='item-container'>
      <div class='item-container-header'>Bluetooth</div>

      <div class='item-container-content'>
        <label class='item'>
          Bluetooth Icon Color (Outside)
          <input id='CONFIG_COLOR_BLUETOOTH_LOGO' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Bluetooth Icon Color (Inside)
          <input id='CONFIG_COLOR_BLUETOOTH_LOGO_2' type='text' class='item-color item-color-normal'>
        </label>
      </div>
      
      <div class='item-container-content'>
        <label class='item'>
          Show Bluetooth Logo When Disconnected
          <input id='CONFIG_BLUETOOTH_LOGO' type='checkbox' class='item-toggle'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Vibrate on Disconnect
          <input id='CONFIG_VIBRATE_DISCONNECT' type='checkbox' class='item-toggle'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Vibrate on Re-connect
          <input id='CONFIG_VIBRATE_RECONNECT' type='checkbox' class='item-toggle'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Message on Disconnect (5 seconds)
          <input id='CONFIG_MESSAGE_DISCONNECT' type='checkbox' class='item-toggle'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Message on Re-connect (5 seconds)
          <input id='CONFIG_MESSAGE_RECONNECT' type='checkbox' class='item-toggle'>
        </label>
      </div>
      
    </div>

    <div class='item-container'>
      <div class='button-container'>
        <input id='submit_button' type='button' class='item-button' value='Save'>
      </div>
    </div>

    <div class='item-container'>
      <div class='button-container'>
        <input id='reset_button' type='button' class='item-button' value='Restore defaults'>
      </div>
    </div>
  <script>
  function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
  }
  function getPlatform() {
    return getParameterByName('platform');
  }
  function isBasalt() {
    return getPlatform() == 'basalt';
  }
  function isChalk() {
    return getPlatform() == 'chalk';
  }

  function getAllConfigHtmlNodes() {
    return $('[id]').filter(function () {
      return /^CONFIG_.*$/.test(this.id);
    });
  }

  function getStorageKey(k) {
    return getPlatform() + "__" + k;
  }

  function writeToStorage(config) {
    for (k in config) {
      localStorage.setItem(getStorageKey(k), config[k]);
    }
  }

  function readConfigFromDom() {
    var options = {};
    getAllConfigHtmlNodes().each(function () {
      var el = $(this);
      var val;
      if (el.hasClass('item-color')) {
        val = GColor.fromHex(el.val().substr(2));
      } else if (el.hasClass('item-toggle')) {
        val = +el.is(':checked');
      } else if (el.hasClass('item-select')) {
        val = +el.val();
      } else {
        console.log("[ error ] Unexpected element:");
        console.log(this);
        return;
      }
      options[this.id] = val;
    });

    console.log('[ info ] configuration read from DOM:');
    console.log(options);
    return options;
  }

  function getQueryParam(variable, defaultValue) {
    var query = location.search.substring(1);
    var vars = query.split('&');
    for (var i = 0; i < vars.length; i++) {
      var pair = vars[i].split('=');
      if (pair[0] === variable) {
        return decodeURIComponent(pair[1]);
      }
    }
    return defaultValue || false;
  }

  function COLOR_FALLBACK(color, bw) {
    if (isBasalt() || isChalk()) return color;
    return bw;
  }

  function PBL_IF_ROUND_ELSE(round, other) {
    if (isChalk()) return round;
    return other;
  }

  function readValuesFromStorage(use_defaults) {
    // default options
    var defaults = {
      CONFIG_COLOR_OUTER_BACKGROUND: COLOR_FALLBACK(GColor.DarkGray, GColor.Black),
      CONFIG_COLOR_INNER_BACKGROUND: COLOR_FALLBACK(GColor.White, GColor.White),
      CONFIG_COLOR_MINUTE_HAND: COLOR_FALLBACK(GColor.Black, GColor.Black),
      CONFIG_COLOR_INNER_MINUTE_HAND: COLOR_FALLBACK(GColor.LightGray, GColor.Black),
      CONFIG_COLOR_HOUR_HAND: COLOR_FALLBACK(GColor.JaegerGreen, GColor.Black),
      CONFIG_COLOR_INNER_HOUR_HAND: COLOR_FALLBACK(GColor.LightGray, GColor.Black),
      CONFIG_COLOR_CIRCLE: COLOR_FALLBACK(GColor.Black, GColor.Black),
      CONFIG_COLOR_TICKS: COLOR_FALLBACK(GColor.Black, GColor.Black),
      CONFIG_COLOR_DAY_OF_WEEK: COLOR_FALLBACK(GColor.JaegerGreen, GColor.Black),
      CONFIG_COLOR_DATE: COLOR_FALLBACK(GColor.Black, GColor.Black),
      CONFIG_BATTERY_LOGO: 1,
      CONFIG_COLOR_BATTERY_LOGO: COLOR_FALLBACK(PBL_IF_ROUND_ELSE(GColor.DarkGray, GColor.Black), GColor.White),
      CONFIG_COLOR_BATTERY_30: COLOR_FALLBACK(PBL_IF_ROUND_ELSE(GColor.Yellow, GColor.Black), GColor.White),
      CONFIG_COLOR_BATTERY_20: COLOR_FALLBACK(PBL_IF_ROUND_ELSE(GColor.Orange, GColor.Black), GColor.White),
      CONFIG_COLOR_BATTERY_10: COLOR_FALLBACK(PBL_IF_ROUND_ELSE(GColor.Red, GColor.Black), GColor.White),
      CONFIG_COLOR_BATTERY_BG_30: COLOR_FALLBACK(PBL_IF_ROUND_ELSE(GColor.White, GColor.Yellow), GColor.Black),
      CONFIG_COLOR_BATTERY_BG_20: COLOR_FALLBACK(PBL_IF_ROUND_ELSE(GColor.White, GColor.Orange), GColor.Black),
      CONFIG_COLOR_BATTERY_BG_10: COLOR_FALLBACK(PBL_IF_ROUND_ELSE(GColor.White, GColor.Red), GColor.Black),
      CONFIG_COLOR_BLUETOOTH_LOGO: COLOR_FALLBACK(GColor.JaegerGreen, GColor.Black),
      CONFIG_COLOR_BLUETOOTH_LOGO_2: COLOR_FALLBACK(GColor.White, GColor.White),
      CONFIG_BLUETOOTH_LOGO: +true,
      CONFIG_VIBRATE_DISCONNECT: +true,
      CONFIG_VIBRATE_RECONNECT: +true,
      CONFIG_MESSAGE_DISCONNECT: +true,
      CONFIG_MESSAGE_RECONNECT: +true,
      CONFIG_MINUTE_TICKS: 1,
      CONFIG_HOUR_TICKS: 1,
    };

    // use defaults
    if (use_defaults || localStorage.getItem(getStorageKey("CONFIG_COLOR_OUTER_BACKGROUND")) === null) {
      console.log("[ info ] loading default values");
      return defaults;
    }

    console.log("[ info ] found previous values");

    var options = {};
    for (k in defaults) {
      if (localStorage.getItem(getStorageKey(k)) === null) {
        options[k] = defaults[k];
      } else {
        options[k] = +localStorage.getItem(getStorageKey(k));
      }
    }

    return options;
  }

  function applyValues(config) {
    getAllConfigHtmlNodes().each(function () {
      var el = $(this);
      var val = config[this.id];
      if (el.hasClass('item-color')) {
        el.val('0x' + GColor.toHex(val));
      } else if (el.hasClass('item-toggle')) {
        el.prop('checked', val);
      } else if (el.hasClass('item-select')) {
        el.val(val);
      } else {
        console.log("[ error ] Unexpected element:");
        console.log(this);
      }
    });
    updateUI();
  }

  function submit(config) {
    // Set the return URL depending on the runtime environment
    var return_to = getQueryParam('return_to', 'pebblejs://close#');
    var url = return_to + encodeURIComponent(JSON.stringify(config));

    // store settings
    writeToStorage(config);

    document.location = url;
  }

  function updateUI() {
    $('.item-color-normal').each(function(e) {
      var $this = $(this);
      var $item = $this.parent();
      $item.find('span.value').css("background-color", '#' + this.value.substr(2));
    });
  }

  // get default values from the url
  $(document).ready(function() {
    // submit button event listener
    var submitButton = document.getElementById('submit_button');
    submitButton.addEventListener('click', function() {
      console.log('[ info ] user clicked submit');

      var config = readConfigFromDom();
      submit(config);
    });

    // submit button event listener
    var resetButton = document.getElementById('reset_button');
    resetButton.addEventListener('click', function() {
      console.log('[ info ] user clicked reset');

      var config = readValuesFromStorage(true);
      submit(config);
    });
    
    applyValues(readValuesFromStorage());

    // hide outer background color for chalk
    if (isChalk()) {
      var el = document.getElementById("CONFIG_COLOR_OUTER_BACKGROUND").parentElement.parentElement;
      el.style.display = "none";
      el = document.getElementById("CONFIG_COLOR_CIRCLE").parentElement.parentElement;
      el.style.display = "none";
    }
  });
  </script>
  </body>
</html>
