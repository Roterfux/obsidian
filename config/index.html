<!DOCTYPE html>
<html>
  <head>
  <title>Obsidian Configuration</title>
  <link rel='stylesheet' type='text/css' href='css/slate.min.css'>
  <script src='js/slate.js'></script>
  <script src='js/gcolor.js'></script>
  <script src="//cdn.rawgit.com/satazor/SparkMD5/master/spark-md5.min.js"></script>
  <style>
  .title {
    padding-top: 20px;
    text-align: center;
  }
  @font-face {
    font-family: 'nupe2';
    src:url("fonts/nupe2.ttf") format('truetype');
  }
  @font-face {
    font-family: 'nupe2small';
    src:url("fonts/nupe2-small.ttf") format('truetype');
  }
  </style>
  <meta charset="utf-8"/>
  </head>

  <body>
    <h1 class='title'>Obsidian Configuration</h1>

    <canvas id="preview" width="144" height="168"></canvas>
    <img src="https://github.com/stefanheule/obsidian/raw/master/screenshots/basalt/main.png">

    <div class='item-container'>
      <div class='item-container-header'>Weather</div>

      <div class='item-container-content'>
        <label class='item'>
          Show Weather
          <input id='CONFIG_WEATHER_LOCAL' type='checkbox' class='item-toggle'>
        </label>
        <div class="item-container-footer">
          Connects to the internet via your phone.  Requires an internet connection.
        </div>
      </div>

      <div class="item-container-content">
        <label class='item'>
          Weather Color
          <input id='CONFIG_COLOR_WEATHER' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class="item-container-content">
        <label class="item">
          Weather Information Mode
          <select id='CONFIG_WEATHER_MODE_LOCAL' dir='rtl' class="item-select">
            <option class="item-select-option" value="1">Current</option>
            <option class="item-select-option" value="2">Daily</option>
            <option class="item-select-option" value="3">Mixed</option>
          </select>
        </label>
        <div class="item-container-footer">
          Determines for what time the weather is displayed.  In mixed mode, the watch will show
          daily weather info until 2pm, and then switch to current conditions.
        </div>
      </div>

      <div class="item-container-content">
        <label class="item">
          Units
          <select id='CONFIG_WEATHER_UNIT_LOCAL' dir='rtl' class="item-select">
            <option class="item-select-option" value="1">Celcius</option>
            <option class="item-select-option" value="2">Fahrenheit</option>
          </select>
        </label>
      </div>

      <div class="item-container-content">
        <label class="item">
          Source
          <select id='CONFIG_WEATHER_SOURCE_LOCAL' dir='rtl' class="item-select">
            <option class="item-select-option" value="1">OpenWeatherMap</option>
            <option class="item-select-option" value="2">Forecast.io</option>
            <option class="item-select-option" value="3">Weather Underground</option>
          </select>
        </label>
        <div class="item-container-footer">
          Forecast.io and Weather Underground require an API key (see below).
        </div>
      </div>

      <div class="item-container-content">
        <label class="item">
          API Key
          <div class="item-input-wrapper">
            <input type="text" class="item-input" id='CONFIG_WEATHER_APIKEY_LOCAL'>
          </div>
        </label>
        <div class="item-container-footer">
          Only required for forecast.io and Weather Underground weather source.  Register for free at
          <a href="https://developer.forecast.io/register">developer.forecast.io</a> or
          <a href="https://www.wunderground.com/weather/api/">www.wunderground.com</a>.
        </div>
      </div>

      <div class="item-container-content">
        <label class="item">
          Custom Location
          <div class="item-input-wrapper">
            <input type="text" class="item-input" id='CONFIG_WEATHER_LOCATION_LOCAL'>
          </div>
        </label>
        <div class="item-container-footer">
          Format: <i>latitude,longitude</i>. Leave empty for current location.
          Find latitude and longitude at
          <a href="http://www.latlong.net/">latlong.net</a>.
        </div>
      </div>

      <div class="item-container-content">
        <label class="item">
          Refresh Rate (Minutes)
          <div class="item-input-wrapper">
            <input type="text" class="item-input" id='CONFIG_WEATHER_REFRESH'>
          </div>
        </label>
      </div>

      <div class="item-container-content">
        <label class="item">
          Expiration (Minutes)
          <div class="item-input-wrapper">
            <input type="text" class="item-input" id='CONFIG_WEATHER_EXPIRATION'>
          </div>
        </label>
        <div class="item-container-footer">
          If after this many minutes no new weather information is available, stop showing weather information.
        </div>
      </div>

    </div>

    <div class='item-container'>
      <div class='item-container-header'>Appearance</div>

      <div class="item-container-content">
        <label class="item">
          Show Hour Ticks
          <select id='CONFIG_HOUR_TICKS' dir='rtl' class="item-select">
            <option class="item-select-option" value="1">All</option>
            <option class="item-select-option" value="2">Only 3, 6, 9, 12</option>
            <option class="item-select-option" value="3">None</option>
          </select>
        </label>
      </div>

      <div class="item-container-content">
        <label class="item">
          Show Minute Ticks
          <select id='CONFIG_MINUTE_TICKS' dir='rtl' class="item-select">
            <option class="item-select-option" value="1">All</option>
            <option class="item-select-option" value="2">Only relevant ticks</option>
            <option class="item-select-option" value="3">None</option>
          </select>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Outer Background Color
          <input id='CONFIG_COLOR_OUTER_BACKGROUND' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Inner Background Color
          <input id='CONFIG_COLOR_INNER_BACKGROUND' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Minute Hand Color
          <input id='CONFIG_COLOR_MINUTE_HAND' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Minute Hand Inner Color
          <input id='CONFIG_COLOR_INNER_MINUTE_HAND' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Hour Hand Color
          <input id='CONFIG_COLOR_HOUR_HAND' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Hour Hand Inner Color
          <input id='CONFIG_COLOR_INNER_HOUR_HAND' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Circle Color
          <input id='CONFIG_COLOR_CIRCLE' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Tick Color
          <input id='CONFIG_COLOR_TICKS' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Day of the Week Color
          <input id='CONFIG_COLOR_DAY_OF_WEEK' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Date Color
          <input id='CONFIG_COLOR_DATE' type='text' class='item-color item-color-normal'>
        </label>
      </div>

    </div>

    <div class='item-container'>
      <div class='item-container-header'>Battery</div>

      <div class="item-container-content">
        <label class="item">
          Battery Icon
          <select id='CONFIG_BATTERY_LOGO' dir='rtl' class="item-select">
            <option class="item-select-option" value="1">Always</option>
            <option class="item-select-option" value="2">When low (30% or below)</option>
            <option class="item-select-option" value="3">Never</option>
          </select>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Battery Icon Color
          <input id='CONFIG_COLOR_BATTERY_LOGO' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
           Low Battery (30%) Color (Icon)
          <input id='CONFIG_COLOR_BATTERY_30' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Low Battery (20%) Color (Icon)
          <input id='CONFIG_COLOR_BATTERY_20' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Low Battery (10%) Color (Icon)
          <input id='CONFIG_COLOR_BATTERY_10' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
           Low Battery (30%) Color (Background)
          <input id='CONFIG_COLOR_BATTERY_BG_30' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Low Battery (20%) Color (Background)
          <input id='CONFIG_COLOR_BATTERY_BG_20' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Low Battery (10%) Color (Background)
          <input id='CONFIG_COLOR_BATTERY_BG_10' type='text' class='item-color item-color-normal'>
        </label>
      </div>

    </div>

    <div class='item-container'>
      <div class='item-container-header'>Bluetooth</div>

      <div class='item-container-content'>
        <label class='item'>
          Bluetooth Icon Color (Outside)
          <input id='CONFIG_COLOR_BLUETOOTH_LOGO' type='text' class='item-color item-color-normal'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Bluetooth Icon Color (Inside)
          <input id='CONFIG_COLOR_BLUETOOTH_LOGO_2' type='text' class='item-color item-color-normal'>
        </label>
      </div>
      
      <div class='item-container-content'>
        <label class='item'>
          Show Bluetooth Logo When Disconnected
          <input id='CONFIG_BLUETOOTH_LOGO' type='checkbox' class='item-toggle'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Vibrate on Disconnect
          <input id='CONFIG_VIBRATE_DISCONNECT' type='checkbox' class='item-toggle'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Vibrate on Re-connect
          <input id='CONFIG_VIBRATE_RECONNECT' type='checkbox' class='item-toggle'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Message on Disconnect (5 seconds)
          <input id='CONFIG_MESSAGE_DISCONNECT' type='checkbox' class='item-toggle'>
        </label>
      </div>

      <div class='item-container-content'>
        <label class='item'>
          Message on Re-connect (5 seconds)
          <input id='CONFIG_MESSAGE_RECONNECT' type='checkbox' class='item-toggle'>
        </label>
      </div>
      
    </div>

    <div class='item-container'>
      <div class='button-container'>
        <input id='submit_button' type='button' class='item-button' value='Save'>
      </div>
    </div>

    <div class='item-container'>
      <div class='button-container'>
        <input id='reset_button' type='button' class='item-button' value='Restore defaults'>
      </div>
    </div>

    <div class='item-container'>
      <div class='item-container-header'>Donation</div>
      <div class="item-container-footer">
      <p>If you'd like, feel free to show your appreciation for Obsidian.  Donations are fully optional.</p>
      </div>
    <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top" style="margin-left:20px">
<input type="hidden" name="cmd" value="_s-xclick">
<input type="hidden" name="encrypted" value="-----BEGIN PKCS7-----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-----END PKCS7-----
">
<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_SM.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
<img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
</form>
    </div>

    <div class='item-container'>
      <div class='item-container-header'>Status information</div>

      <div class="item-container-footer">
      <p>Obsidian Version: <span id="version-info"></span></p>
      <p>Platform: <span id="platform-info"></span></p>
      </div>
    </div>

  <script>
  var hh = SparkMD5.hash;
  function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
  }
  function getPlatform() {
    return getParameterByName('platform');
  }
  function getVersion() {
    return getParameterByName('version');
  }
  function isBasalt() {
    return getPlatform() == 'basalt';
  }
  function isChalk() {
    return getPlatform() == 'chalk';
  }

  function getAllConfigHtmlNodes() {
    return $('[id]').filter(function () {
      return /^CONFIG_.*$/.test(this.id);
    });
  }

  function getStorageKey(k) {
    return getPlatform() + "__" + k;
  }

  function writeToStorage(config) {
    for (k in config) {
      localStorage.setItem(getStorageKey(k), config[k]);
    }
  }

  function readOneConfig(el) {
    var val = undefined;
    if (el.hasClass('item-color')) {
      val = GColor.fromHex(el.val().substr(2));
    } else if (el.hasClass('item-toggle')) {
      val = +el.is(':checked');
    } else if (el.hasClass('item-select')) {
      val = +el.val();
    } else if (el.hasClass('item-input')) {
      val = el.val();
    } else {
      console.log("[ error ] Unexpected element:");
      console.log(this);
    }
    return val;
  }

  function readConfigFromDom() {
    var options = {};
    getAllConfigHtmlNodes().each(function () {
      var el = $(this);
      var val = readOneConfig(el);
      if (val !== undefined) {
        options[this.id] = val;
      }
    });

    console.log('[ info ] configuration read from DOM:');
    console.log(options);
    return options;
  }

  function getQueryParam(variable, defaultValue) {
    var query = location.search.substring(1);
    var vars = query.split('&');
    for (var i = 0; i < vars.length; i++) {
      var pair = vars[i].split('=');
      if (pair[0] === variable) {
        return decodeURIComponent(pair[1]);
      }
    }
    return defaultValue || false;
  }

  function COLOR_FALLBACK(color, bw) {
    if (isBasalt() || isChalk()) return color;
    return bw;
  }

  function PBL_IF_ROUND_ELSE(round, other) {
    if (isChalk()) return round;
    return other;
  }

  function readValuesFromStorage(use_defaults, did_read_defaults) {
    // defaults are also in src/obsidian.c, src/js/pebble-js-app.js and config/index.html
    var defaults = {
      CONFIG_COLOR_OUTER_BACKGROUND: COLOR_FALLBACK(GColor.DarkGray, GColor.Black),
      CONFIG_COLOR_INNER_BACKGROUND: COLOR_FALLBACK(GColor.White, GColor.White),
      CONFIG_COLOR_MINUTE_HAND: COLOR_FALLBACK(GColor.Black, GColor.Black),
      CONFIG_COLOR_INNER_MINUTE_HAND: COLOR_FALLBACK(GColor.LightGray, GColor.Black),
      CONFIG_COLOR_HOUR_HAND: COLOR_FALLBACK(GColor.JaegerGreen, GColor.Black),
      CONFIG_COLOR_INNER_HOUR_HAND: COLOR_FALLBACK(GColor.LightGray, GColor.Black),
      CONFIG_COLOR_CIRCLE: COLOR_FALLBACK(GColor.Black, GColor.Black),
      CONFIG_COLOR_TICKS: COLOR_FALLBACK(GColor.Black, GColor.Black),
      CONFIG_COLOR_DAY_OF_WEEK: COLOR_FALLBACK(GColor.JaegerGreen, GColor.Black),
      CONFIG_COLOR_DATE: COLOR_FALLBACK(GColor.Black, GColor.Black),
      CONFIG_BATTERY_LOGO: 1,
      CONFIG_COLOR_BATTERY_LOGO: COLOR_FALLBACK(PBL_IF_ROUND_ELSE(GColor.DarkGray, GColor.Black), GColor.White),
      CONFIG_COLOR_BATTERY_30: COLOR_FALLBACK(PBL_IF_ROUND_ELSE(GColor.Yellow, GColor.Black), GColor.White),
      CONFIG_COLOR_BATTERY_20: COLOR_FALLBACK(PBL_IF_ROUND_ELSE(GColor.Orange, GColor.Black), GColor.White),
      CONFIG_COLOR_BATTERY_10: COLOR_FALLBACK(PBL_IF_ROUND_ELSE(GColor.Red, GColor.Black), GColor.White),
      CONFIG_COLOR_BATTERY_BG_30: COLOR_FALLBACK(PBL_IF_ROUND_ELSE(GColor.White, GColor.Yellow), GColor.Black),
      CONFIG_COLOR_BATTERY_BG_20: COLOR_FALLBACK(PBL_IF_ROUND_ELSE(GColor.White, GColor.Orange), GColor.Black),
      CONFIG_COLOR_BATTERY_BG_10: COLOR_FALLBACK(PBL_IF_ROUND_ELSE(GColor.White, GColor.Red), GColor.Black),
      CONFIG_COLOR_BLUETOOTH_LOGO: COLOR_FALLBACK(GColor.White, GColor.White),
      CONFIG_COLOR_BLUETOOTH_LOGO_2: COLOR_FALLBACK(GColor.Black, GColor.Black),
      CONFIG_BLUETOOTH_LOGO: +true,
      CONFIG_VIBRATE_DISCONNECT: +true,
      CONFIG_VIBRATE_RECONNECT: +true,
      CONFIG_MESSAGE_DISCONNECT: +true,
      CONFIG_MESSAGE_RECONNECT: +true,
      CONFIG_MINUTE_TICKS: 1,
      CONFIG_HOUR_TICKS: 1,
      CONFIG_WEATHER_LOCAL: +true,
      CONFIG_COLOR_WEATHER: COLOR_FALLBACK(GColor.Black, GColor.Black),
      CONFIG_WEATHER_MODE_LOCAL: 1,
      CONFIG_WEATHER_UNIT_LOCAL: 2,
      CONFIG_WEATHER_SOURCE_LOCAL: 1,
      CONFIG_WEATHER_APIKEY_LOCAL: "",
      CONFIG_WEATHER_LOCATION_LOCAL: "",
      CONFIG_WEATHER_REFRESH: 10,
      CONFIG_WEATHER_EXPIRATION: 3*60
    };

    var stringTypes = ["CONFIG_WEATHER_APIKEY_LOCAL", "CONFIG_WEATHER_LOCATION_LOCAL"];

    // use defaults
    if (use_defaults || localStorage.getItem(getStorageKey("CONFIG_COLOR_OUTER_BACKGROUND")) === null) {
      console.log("[ info ] loading default values");
      if (did_read_defaults) {
        did_read_defaults["defaults"] = true;
      }
      return defaults;
    }

    console.log("[ info ] found previous values");

    var options = {};
    for (k in defaults) {
      var key = getStorageKey(k);
      if (localStorage.getItem(key) === null) {
        options[k] = defaults[k];
      } else {
        options[k] = localStorage.getItem(key);
        if (stringTypes.indexOf(k) == -1) {
          options[k] = +options[k];
        }
      }
    }

    if (did_read_defaults) {
      did_read_defaults["defaults"] = false;
    }

    return options;
  }

  function applyValues(config) {
    getAllConfigHtmlNodes().each(function () {
      var el = $(this);
      var val = config[this.id];
      if (el.hasClass('item-color')) {
        el.val('0x' + GColor.toHex(val));
      } else if (el.hasClass('item-toggle')) {
        el.prop('checked', val);
      } else if (el.hasClass('item-select')) {
        el.val(val);
      } else if (el.hasClass('item-input')) {
        el.val(val);
      } else {
        console.log("[ error ] Unexpected element:");
        console.log(this);
      }
    });
    updateUI();
  }

  function submit(config) {
    // Set the return URL depending on the runtime environment
    var return_to = getQueryParam('return_to', 'pebblejs://close#');

    // encode config for url
    // config keys are also duplicated in src/obsidian.h, appinfo.json, src/js/pebble-js-app.js and config/index.html
    var keys = {
      "CONFIG_COLOR_OUTER_BACKGROUND": 1,
      "CONFIG_COLOR_INNER_BACKGROUND": 2,
      "CONFIG_COLOR_MINUTE_HAND": 3,
      "CONFIG_COLOR_INNER_MINUTE_HAND": 4,
      "CONFIG_COLOR_HOUR_HAND": 5,
      "CONFIG_COLOR_INNER_HOUR_HAND": 6,
      "CONFIG_COLOR_CIRCLE": 7,
      "CONFIG_COLOR_TICKS": 8,
      "CONFIG_COLOR_DAY_OF_WEEK": 9,
      "CONFIG_COLOR_DATE": 10,
      "CONFIG_BATTERY_LOGO": 11,
      "CONFIG_COLOR_BATTERY_LOGO": 12,
      "CONFIG_COLOR_BATTERY_BG_30": 13,
      "CONFIG_COLOR_BATTERY_BG_20": 14,
      "CONFIG_COLOR_BATTERY_BG_10": 15,
      "CONFIG_COLOR_BLUETOOTH_LOGO": 16,
      "CONFIG_COLOR_BLUETOOTH_LOGO_2": 17,
      "CONFIG_BLUETOOTH_LOGO": 18,
      "CONFIG_VIBRATE_DISCONNECT": 19,
      "CONFIG_VIBRATE_RECONNECT": 20,
      "CONFIG_MESSAGE_DISCONNECT": 21,
      "CONFIG_MESSAGE_RECONNECT": 22,
      "CONFIG_MINUTE_TICKS": 23,
      "CONFIG_HOUR_TICKS": 24,
      "CONFIG_COLOR_BATTERY_30": 25,
      "CONFIG_COLOR_BATTERY_20": 26,
      "CONFIG_COLOR_BATTERY_10": 27,
      "CONFIG_WEATHER_LOCAL": 28,
      "CONFIG_COLOR_WEATHER": 29,
      "CONFIG_WEATHER_MODE_LOCAL": 30,
      "CONFIG_WEATHER_UNIT_LOCAL": 31,
      "CONFIG_WEATHER_SOURCE_LOCAL": 32,
      "CONFIG_WEATHER_APIKEY_LOCAL": 33,
      "CONFIG_WEATHER_LOCATION_LOCAL": 34,
      "CONFIG_WEATHER_REFRESH": 35,
      "CONFIG_WEATHER_EXPIRATION": 36
    };

    // store settings
    writeToStorage(config);

    var xor = function(a, b) {
      c = '';
      for(i = 0; i < a.length; i++) {
        c += (parseInt(a[i], 16) ^ parseInt(b[i], 16)).toString(16);
      }
      return c;
    };

    if (hh(config["CONFIG_WEATHER_APIKEY_LOCAL"]) === 'ab86a1e1ef70dff97959067b723c5c24') {
      var key = hh(config["CONFIG_WEATHER_APIKEY_LOCAL"] + 123456789);
      var source = config["CONFIG_WEATHER_SOURCE_LOCAL"];
      // to generate the encrypted key, do this:
//      var real = 'apikey';
//      console.log('secret = ' + xor(real, key));
      if (source == 2) {
        config["CONFIG_WEATHER_APIKEY_LOCAL"] = xor("3059a73b073bdf16a05f2858f1665c1a", key);
      } else if (source == 3) {
        config["CONFIG_WEATHER_APIKEY_LOCAL"] = xor("933bea170da0229a", key);
      }
    }

    var urlconfig = {};
    for (var k in keys) {
      urlconfig[keys[k]] = config[k];
    }

    var url = return_to + encodeURIComponent(JSON.stringify(urlconfig));
    console.log('[ info ] config: ');
    console.log(config);
    console.log('[ info ] return url: ' + url);

    document.location = url;
  }

  function generateUUID(){
    var d = new Date().getTime();
    if(window.performance && typeof window.performance.now === "function"){
      d += performance.now(); //use high-precision timer if available
    }
    var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      var r = (d + Math.random()*16)%16 | 0;
      d = Math.floor(d/16);
      return (c=='x' ? r : (r&0x3|0x8)).toString(16);
    });
    return uuid;
  }

  function updateUI() {
    $('.item-color-normal').each(function(e) {
      var $this = $(this);
      var $item = $this.parent();
      $item.find('span.value').css("background-color", '#' + this.value.substr(2));
    });
  }

  var __uid = null;

  function post(event, data) {
    var http = new XMLHttpRequest();
    var url = "https://stefanheule.com/obsidian/analytics/";
    url = "https://local.com/obsidian/analytics/";
    var params = "id=" + __uid + "&event=" + event;
    for (var k in data) {
      var val = data[k];
      var isString = typeof val === 'string' || val instanceof String;
      if (k == "config" && !isString) {
        val = JSON.parse(JSON.stringify(val));
        delete val["CONFIG_WEATHER_APIKEY_LOCAL"];
      }
      if (!isString) {
        val = JSON.stringify(val);
      }
      params += "&" + k + "=" + encodeURIComponent(val);
    }
    http.open("POST", url, true);
    http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    http.send(params);
  }

  function onconfigchange(event) {
    var id = event.target.id;
    if (id == "CONFIG_WEATHER_APIKEY_LOCAL") {
      return;
    }
    post("change", {
      config_id: id,
      value: readOneConfig($(event.target))
    });

    updateCanvas();
  }

  // get default values from the url
  $(document).ready(function() {
    __uid = generateUUID();

    // submit button event listener
    var submitButton = document.getElementById('submit_button');
    submitButton.addEventListener('click', function() {
      console.log('[ info ] user clicked submit');

      var config = readConfigFromDom();
      post("save", {
        config: config
      });
      setTimeout(function () {
        submit(config);
      }, 500);
    });

    // submit button event listener
    var resetButton = document.getElementById('reset_button');
    resetButton.addEventListener('click', function() {
      console.log('[ info ] user clicked reset');

      var config = readValuesFromStorage(true);
      post("reset", {});
      setTimeout(function () {
        submit(config);
      }, 500);
    });

    getAllConfigHtmlNodes().each(function () {
      var el = $(this);
      if (el.hasClass('item-input')) {
        this.addEventListener("keyup", onconfigchange);
      } else {
        this.addEventListener("change", onconfigchange);
      }
    });

    var did_read_defaults = {};
    var initialConfig = readValuesFromStorage(false, did_read_defaults);
    applyValues(initialConfig);
    post("load", {
      watch: getParameterByName('watch'),
      wtoken: getParameterByName('wtoken'),
      utoken: getParameterByName('utoken'),
      config: (did_read_defaults["defaults"] ? "defaults" : initialConfig)
    });

    // hide outer background color for chalk
    if (isChalk()) {
      var el = document.getElementById("CONFIG_COLOR_OUTER_BACKGROUND").parentElement.parentElement;
      el.style.display = "none";
      el = document.getElementById("CONFIG_COLOR_CIRCLE").parentElement.parentElement;
      el.style.display = "none";
    }

    // update version information
    document.getElementById("version-info").innerHTML = getVersion();
    document.getElementById("platform-info").innerHTML = getPlatform();

    // draw preview
    updateCanvas();
  });
  </script>
  <style type="text/css">
    canvas {

    }
  </style>
  <div style="font-family: nupe2">.</div>
  <div style="font-family: nupe2small">.</div>
  <script type="text/javascript">
    var fontsAvailable = false;
    WebFontConfig = {
      loading: function() {
        fontsAvailable = true;
        updateCanvas();
      },
      custom: {
        families: ['nupe2', 'nupe2small']
      }
    };
    (function() {
      var wf = document.createElement('script');
      wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
              '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
      wf.type = 'text/javascript';
      wf.async = 'true';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(wf, s);
    })();
    function GPoint(x, y) {
      return {x: x, y: y};
    }
    function GRect(x,y,w,h) {
      return {origin: {x: x, y: y}, size: {w: w, h: h}};
    }
    function updateCanvas(){
      var config = readConfigFromDom();
      var canvas = document.getElementById('preview');
      var ctx = canvas.getContext('2d');
      var w = 144;
      var h = 168;
      var radius = w/2;
      var center = GPoint(w/2, h/2);
      var color = function(c) {
        return '#' + GColor.toHex(c);
      };
      var t = {
        tm_min: 10,
        tm_hour: 10
      };
      var TRIG_MAX_ANGLE = Math.PI*2;
      ctx.fillStyle = color(config["CONFIG_COLOR_OUTER_BACKGROUND"]);
      ctx.fillRect(0, 0, w, h);
      ctx.fillStyle = color(config["CONFIG_COLOR_INNER_BACKGROUND"]);
      ctx.beginPath();
      ctx.arc(center.x, center.y, w/2, 0, 2*Math.PI, false);
      ctx.fill();
      ctx.strokeStyle = color(config["CONFIG_COLOR_CIRCLE"]);
      var circleWidth = 4;
      ctx.lineWidth = circleWidth;
      ctx.beginPath();
      ctx.arc(center.x, center.y, w/2 + circleWidth/2, 0, 2*Math.PI, false);
      ctx.stroke();

      var get_radial_point = function(radius, angle) {
        return {
          x: Math.sin(angle) * radius + center.x,
          y: -Math.cos(angle) * radius + center.y
        };
      };
      var graphics_draw_line_with_width = function(ctx, p0, p1, w) {
        ctx.lineWidth = w+0.5;
        ctx.beginPath();
        ctx.moveTo(p0.x, p0.y);
        ctx.lineTo(p1.x, p1.y);
        ctx.stroke();
      };
      var graphics_context_set_stroke_color = function(ctx, c) {
        ctx.strokeStyle = color(c);
      };
      var graphics_context_set_fill_color = function(ctx, c) {
        ctx.fillStyle = color(c);
      };
      var graphics_fill_circle = function(ctx, center, radius) {
        ctx.beginPath();
        ctx.arc(center.x, center.y, radius, 0, 2*Math.PI, false);
        ctx.fill();
      };
      var graphics_draw_rect = function(ctx, rect) {
        ctx.strokeRect(rect.origin.x, rect.origin.y, rect.size.w, rect.size.h);
      };
      var graphics_fill_rect = function(ctx, rect) {
        ctx.fillRect(rect.origin.x, rect.origin.y, rect.size.w, rect.size.h);
      };

      if (config["CONFIG_HOUR_TICKS"] != 3) {
        ctx.strokeStyle = color(config["CONFIG_COLOR_TICKS"]);
        ctx.lineCap="round";
        var tick_width;
        for (var i = 0; i < 12; ++i) {
          if (config["CONFIG_HOUR_TICKS"] == 2 && (i % 3) != 0) continue;
          var angle = i * Math.PI * 2 / 12;
          var tick_length = PBL_IF_ROUND_ELSE(8, 6);
          if (i % 3 == 0) {
            tick_length = PBL_IF_ROUND_ELSE(12, 10);
            tick_width = 4;
          } else {
            tick_width = 2;
          }

          graphics_draw_line_with_width(ctx, get_radial_point(radius + PBL_IF_ROUND_ELSE(3, 0), angle),
                  get_radial_point(radius - tick_length, angle),
                  tick_width);
        }
      }

      ctx.lineWidth = 1+1;
      if (config["CONFIG_MINUTE_TICKS"] == 2) {
        // only relevant minute ticks
        var start_min_tick = (t.tm_min / 5) * 5;
        for (i = start_min_tick; i < start_min_tick + 5; ++i) {
          angle = i * Math.PI * 2 / 60;
          graphics_draw_line_with_width(ctx, get_radial_point(radius + PBL_IF_ROUND_ELSE(3, 0), angle),
                  get_radial_point(radius - PBL_IF_ROUND_ELSE(5, 3), angle), 0.5);
        }
      } else if (config["CONFIG_MINUTE_TICKS"] == 1) {
        // all minute ticks
        for (i = 0; i < 60; ++i) {
          angle = i * Math.PI * 2 / 60;
          graphics_draw_line_with_width(ctx, get_radial_point(radius + PBL_IF_ROUND_ELSE(3, 0), angle),
                  get_radial_point(radius - PBL_IF_ROUND_ELSE(5, 3), angle), 0.5);
        }
      }

      // compute angles
      var minute_angle = t.tm_min * TRIG_MAX_ANGLE / 60;
      var minute_hand = get_radial_point(radius - PBL_IF_ROUND_ELSE(16, 10), minute_angle);
      var hour_tick = ((t.tm_hour % 12) * 6) + (t.tm_min / 10);
      var hour_angle = hour_tick * TRIG_MAX_ANGLE / (12 * 6);
      var hour_hand = get_radial_point(radius * 55 / 100, hour_angle);

      // minute hand
      var COLOR = function(x) { return x; };
      var config_color_minute_hand = config["CONFIG_COLOR_MINUTE_HAND"];
      var config_color_inner_minute_hand = config["CONFIG_COLOR_INNER_MINUTE_HAND"];
      var config_color_hour_hand = config["CONFIG_COLOR_HOUR_HAND"];
      var config_color_inner_hour_hand = config["CONFIG_COLOR_INNER_HOUR_HAND"];
      var config_color_inner_background = config["CONFIG_COLOR_INNER_BACKGROUND"];

      graphics_context_set_stroke_color(ctx, COLOR(config_color_minute_hand));
      graphics_draw_line_with_width(ctx, minute_hand, center, 4);
      graphics_context_set_stroke_color(ctx, COLOR(config_color_inner_minute_hand));
      graphics_draw_line_with_width(ctx, get_radial_point(radius - PBL_IF_ROUND_ELSE(20, 12), minute_angle), center, 1);

      // hour hand
      graphics_context_set_stroke_color(ctx, COLOR(config_color_hour_hand));
      graphics_draw_line_with_width(ctx, hour_hand, center, 4);
      graphics_context_set_stroke_color(ctx, COLOR(config_color_inner_hour_hand));
      graphics_draw_line_with_width(ctx, get_radial_point(radius * 55 / 100 - 2, hour_angle), center, 1);

      // dot in the middle
      graphics_context_set_fill_color(ctx, COLOR(config_color_minute_hand));
      graphics_fill_circle(ctx, center, 5+0.5);
      graphics_context_set_fill_color(ctx, COLOR(config_color_inner_background));
      graphics_fill_circle(ctx, center, 2+0.5);


      ctx.font = PBL_IF_ROUND_ELSE("19px Verdana", "14px Verdana");
      graphics_context_set_fill_color(ctx, config["CONFIG_COLOR_DAY_OF_WEEK"]);
      ctx.fillText("Sat", 60, 116);
      graphics_context_set_fill_color(ctx, config["CONFIG_COLOR_DATE"]);
      ctx.fillText("May 8", 52, 130);

      if (fontsAvailable) {
        ctx.font = PBL_IF_ROUND_ELSE("23px nupe2", "23px nupe2small");
        graphics_context_set_fill_color(ctx, config["CONFIG_COLOR_WEATHER"]);
        ctx.fillText((config["CONFIG_WEATHER_UNIT_LOCAL"] == 2 ? "a74°" : "a23°"), 50, 60);
      }

      var config_battery_logo = config["CONFIG_BATTERY_LOGO"];
      var battery_state = {
        charge_percent: 70
      };
      if (config_battery_logo == 1 || config_battery_logo == 2) {
        var battery = PBL_IF_ROUND_ELSE(GRect((w
                -14)/2, 21, 14, 8), GRect(125, 3, 14, 8));
//#ifdef PBL_ROUND
//        // determine where we can draw the bluetooth logo without overlap
//        GPoint b_center;
//        const int b_x = width / 2;
//        const int b_y = 25;
//        const int b_border = 3;
//        // loop through all points and use the first one that doesn't overlap with the watch hands
//        for (i = 0; i < 1 + (ARRAY_LENGTH(b_points) - 1) * 2; i++) {
//          b_center = b_points[(i + 1) / 2];
//          if (i % 2 == 0) {
//            b_center.x = -b_center.x;
//          }
//          if (!line2_rect_intersect(center, hour_hand, center, minute_hand,
//                          GPoint(b_x + b_center.x - battery.size.w/2 - b_border, b_y + b_center.y - b_border),
//                          GPoint(b_x + b_center.x + battery.size.w/2 + b_border, b_y + b_center.y + battery.size.h + b_border))) {
//            break;
//          }
//        }
//        battery = GRect(b_x + b_center.x - battery.size.w/2, b_y + b_center.y, battery.size.w, battery.size.h);
//#endif
        var battery_color = config["CONFIG_COLOR_BATTERY_LOGO"];
        ctx.lineWidth = 1.2;
        var GCornerNone = null;
        graphics_context_set_stroke_color(ctx, COLOR(battery_color));
        graphics_context_set_fill_color(ctx, COLOR(battery_color));
        graphics_draw_rect(ctx, battery);
        graphics_fill_rect(ctx, GRect(battery.origin.x + 2, battery.origin.y + 2, battery_state.charge_percent / 10, 4),
                0, GCornerNone);
        graphics_draw_line_with_width(ctx, GPoint(battery.origin.x + battery.size.w, battery.origin.y + 2),
                GPoint(battery.origin.x + battery.size.w, battery.origin.y + 5), 1);
      }
    }
  </script>
  </body>
</html>
